#!/bin/bash

# Created by: Joshua McKee
#
# Adds an entry to the hosts file for a VM created by the cloud client by 
# reading a file generated by the cloud client script (cloud-client.sh). Once 
# the file exists, the entry is added.
# Meant to be used with cloud-client.sh
# Meant to be paired with remove-host-entry
# Arguments:
#  $1 - The file generated by the cloud client
#
# NOTE: Passwordless sudo required for script to run properly!

sourcefile=$1

# wait until file with vm info exists
while [ ! -f $sourcefile ]
do
    sleep 1
done
sleep 10 # wait for file to be written to

vm_handle=$(cat $sourcefile | grep "Creating workspace" | awk '{print $3}' | \
    sed -e 's/^"//' -e 's/"...$//')
vm_ip=$(cat $sourcefile | grep "IP address" | awk '{print $3}')
vm_hostname=$(cat $sourcefile | grep "Hostname" | awk '{print $2}')

sudo sed -i "/^$vm_ip\t.*$/d" /etc/hosts
sudo sed -i "/testbed vms/a $vm_ip\t$vm_hostname\t# $vm_handle" /etc/hosts

# clean up
rm -f $sourcefile

exit 0
